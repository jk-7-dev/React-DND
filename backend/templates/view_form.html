<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Name }}</title>
    <style>
        /* Lightweight CSS (No Framework needed) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f3f4f6; margin: 0; padding: 20px; }
        .container { max-width: 640px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        h1 { margin-top: 0; color: #1f2937; border-bottom: 1px solid #e5e7eb; padding-bottom: 20px; margin-bottom: 30px; }
        .form-group { margin-bottom: 24px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; }
        .required { color: #dc2626; margin-left: 4px; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="date"], textarea, select {
            width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; box-sizing: border-box; transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 2px #bfdbfe; }
        button[type="submit"] {
            width: 100%; background-color: #2563eb; color: white; font-weight: 600; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background 0.2s;
        }
        button[type="submit"]:hover { background-color: #1d4ed8; }
        
        /* Star Rating CSS */
        .stars { display: flex; gap: 5px; }
        .star { font-size: 24px; cursor: pointer; color: #d1d5db; transition: color 0.2s; background: none; border: none; padding: 0; }
        .star.active { color: #facc15; }

        /* Video Recorder CSS */
        .video-container { border: 2px dashed #d1d5db; border-radius: 8px; padding: 10px; text-align: center; background: #f9fafb; }
        video { width: 100%; border-radius: 6px; background: black; display: none; margin-bottom: 10px; }
        .video-btn { background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-size: 14px; }
        .video-btn.stop { background: #374151; }
    </style>
</head>
<body>

<div class="container">
    <h1>{{ .Name }}</h1>
    <form id="mainForm">
        {{ range .Elements }}
        <div class="form-group">
            <label>
                {{ .Label }} 
                {{ if .Required }}<span class="required">*</span>{{ end }}
            </label>

            {{ if eq .Type "text" }}
                <input type="text" name="{{ .ID }}" placeholder="{{ .Placeholder }}" {{ if .Required }}required{{ end }}>
            {{ else if eq .Type "email" }}
                <input type="email" name="{{ .ID }}" placeholder="{{ .Placeholder }}" {{ if .Required }}required{{ end }}>
            {{ else if eq .Type "phone" }}
                <input type="tel" name="{{ .ID }}" placeholder="{{ .Placeholder }}" {{ if .Required }}required{{ end }}>
            {{ else if eq .Type "date" }}
                <input type="date" name="{{ .ID }}" {{ if .Required }}required{{ end }}>
            {{ else if eq .Type "textarea" }}
                <textarea name="{{ .ID }}" rows="4" placeholder="{{ .Placeholder }}" {{ if .Required }}required{{ end }}></textarea>
            {{ else if eq .Type "select" }}
                <select name="{{ .ID }}" {{ if .Required }}required{{ end }}>
                    <option value="" disabled selected>Select an option</option>
                    <option value="Option 1">Option 1</option>
                    <option value="Option 2">Option 2</option>
                </select>
            {{ else if eq .Type "stars" }}
                <div class="stars" id="stars-{{ .ID }}">
                    <input type="hidden" name="{{ .ID }}" id="input-{{ .ID }}" {{ if .Required }}required{{ end }}>
                    <button type="button" class="star" onclick="setRating('{{ .ID }}', 1)">★</button>
                    <button type="button" class="star" onclick="setRating('{{ .ID }}', 2)">★</button>
                    <button type="button" class="star" onclick="setRating('{{ .ID }}', 3)">★</button>
                    <button type="button" class="star" onclick="setRating('{{ .ID }}', 4)">★</button>
                    <button type="button" class="star" onclick="setRating('{{ .ID }}', 5)">★</button>
                </div>
            {{ else if eq .Type "video" }}
                <div class="video-container" id="video-wrapper-{{ .ID }}">
                    <input type="hidden" name="{{ .ID }}" id="input-{{ .ID }}" {{ if .Required }}required{{ end }}>
                    <video id="preview-{{ .ID }}" autoplay muted playsinline></video>
                    <video id="playback-{{ .ID }}" controls></video>
                    <div style="margin-top: 10px;">
                        <button type="button" id="btn-start-{{ .ID }}" class="video-btn" onclick="startRecording('{{ .ID }}')">Start Recording</button>
                        <button type="button" id="btn-stop-{{ .ID }}" class="video-btn stop" onclick="stopRecording('{{ .ID }}')" style="display:none;">Stop Recording</button>
                    </div>
                    <p id="status-{{ .ID }}" style="font-size: 12px; color: #6b7280; margin-top: 5px;">Ready to record</p>
                </div>
            {{ end }}
        </div>
        {{ end }}

        <button type="submit" id="submitBtn">Submit Form</button>
    </form>
</div>

<script>
    // --- STAR RATING LOGIC ---
    function setRating(id, value) {
        document.getElementById('input-' + id).value = value;
        const container = document.getElementById('stars-' + id);
        const stars = container.querySelectorAll('.star');
        stars.forEach((star, index) => {
            star.classList.toggle('active', index < value);
        });
    }

    // --- VIDEO RECORDING LOGIC (Vanilla JS) ---
    let recorders = {};
    let chunks = {};

    async function startRecording(id) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            const preview = document.getElementById('preview-' + id);
            
            preview.style.display = 'block';
            document.getElementById('playback-' + id).style.display = 'none';
            preview.srcObject = stream;

            const mediaRecorder = new MediaRecorder(stream);
            recorders[id] = mediaRecorder;
            chunks[id] = [];

            mediaRecorder.ondataavailable = (e) => chunks[id].push(e.data);
            
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks[id], { type: 'video/webm' });
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => {
                    // Save Base64 to hidden input
                    document.getElementById('input-' + id).value = reader.result;
                };

                // Show playback
                preview.style.display = 'none';
                const playback = document.getElementById('playback-' + id);
                playback.src = URL.createObjectURL(blob);
                playback.style.display = 'block';
                
                // Stop camera stream
                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();

            // Toggle Buttons
            document.getElementById('btn-start-' + id).style.display = 'none';
            document.getElementById('btn-stop-' + id).style.display = 'inline-flex';
            document.getElementById('status-' + id).innerText = "Recording...";
        } catch (err) {
            alert("Camera access denied or not supported.");
            console.error(err);
        }
    }

    function stopRecording(id) {
        if (recorders[id] && recorders[id].state !== 'inactive') {
            recorders[id].stop();
            document.getElementById('btn-start-' + id).style.display = 'inline-flex';
            document.getElementById('btn-start-' + id).innerText = 'Retake';
            document.getElementById('btn-stop-' + id).style.display = 'none';
            document.getElementById('status-' + id).innerText = "Video captured!";
        }
    }

    // --- SUBMISSION LOGIC ---
    document.getElementById('mainForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "Submitting...";

        // Collect Data
        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => data[key] = value);

        // Get Form ID from URL path (assuming /public/forms/{id})
        const pathParts = window.location.pathname.split('/');
        const formId = parseInt(pathParts[pathParts.length - 1]);

        try {
            const response = await fetch('http://localhost:8080/api/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    form_schema_id: formId,
                    data: JSON.stringify(data)
                })
            });

            if (response.ok) {
                document.querySelector('.container').innerHTML = `
                    <div style="text-align:center; padding: 40px;">
                        <h2 style="color: #059669;">Thank You!</h2>
                        <p>Your submission has been received.</p>
                    </div>`;
            } else {
                alert("Submission failed. Please try again.");
                btn.disabled = false;
                btn.innerText = "Submit Form";
            }
        } catch (err) {
            console.error(err);
            alert("Error connecting to server.");
            btn.disabled = false;
        }
    });
</script>

</body>
</html>